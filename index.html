<!-- Giallo Scores Widget - Versión Pro Elite por Lorenzo Giamborino -->
<div id="giallo-widget-root" style="background-color: #000000; color: #ffffff; border-radius: 0px; overflow: hidden; max-width: 480px; margin: 0 auto; font-family: 'Archivo', sans-serif; min-height: 100vh;">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo:wght@400;700;900&display=swap');
        
        /* Eliminar bordes blancos de cualquier contenedor */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        #giallo-widget-root .league-header {
            background: #0a0a0a;
            padding: 8px 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #111;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #giallo-widget-root .match-card {
            background: #050505; 
            border-bottom: 1px solid #111;
            padding: 16px 24px; 
            cursor: pointer; 
            transition: 0.2s;
        }
        #giallo-widget-root .match-card:active { background: #111; }

        #giallo-widget-root .status-label {
            font-size: 8px; font-weight: 900; padding: 3px 8px; border-radius: 6px; text-transform: uppercase;
        }
        #giallo-widget-root .status-live { background: #ef4444; color: white; animation: giallo-pulse 1.5s infinite; }
        #giallo-widget-root .status-final { background: #222; color: #666; }
        #giallo-widget-root .status-next { background: #000; color: #3b82f6; border: 1px solid #3b82f644; }

        @keyframes giallo-pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        #giallo-widget-root .btn-nav {
            background: #0a0a0a; color: #444; padding: 10px; border-radius: 12px; font-size: 10px; font-weight: 900; flex: 1; border: 1px solid #111; cursor: pointer;
        }
        #giallo-widget-root .btn-nav.active { background: #3b82f6; color: white; border-color: #3b82f6; }

        #giallo-widget-root .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 100; display: none; overflow-y: auto; padding: 20px;
        }
        #giallo-widget-root .scroll-area::-webkit-scrollbar { display: none; }
        
        #giallo-widget-root .stat-bar-bg { background: #111; height: 4px; border-radius: 2px; display: flex; overflow: hidden; margin-top: 4px; }
        #giallo-widget-root .stat-fill-l { background: #3b82f6; height: 100%; }
        #giallo-widget-root .stat-fill-r { background: #333; height: 100%; }
    </style>

    <!-- Header -->
    <div style="padding: 24px; background: #000;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h2 style="margin: 0; font-size: 20px; font-weight: 900; font-style: italic; text-transform: uppercase; letter-spacing: -1px;">GIALLO <span style="color: #3b82f6;">SCORES</span></h2>
                <p id="tn-clock" style="margin: 2px 0 0 0; font-size: 8px; color: #333; font-weight: 700; text-transform: uppercase;"></p>
            </div>
            <button onclick="toggleSearchUI()" style="background: #111; border: none; color: white; padding: 10px 14px; border-radius: 12px; font-size: 9px; font-weight: 900; cursor: pointer;">BUSCAR</button>
        </div>
        <div id="fav-container" style="display: flex; gap: 12px; overflow-x: auto;" class="scroll-area"></div>
    </div>

    <!-- Buscador -->
    <div id="search-box" style="display: none; padding: 0 24px 20px 24px; background: #000;">
        <input type="text" id="team-search-input" style="width:100%; background:#0a0a0a; border:1px solid #111; border-radius:14px; padding:14px; color:white; outline:none; font-size: 12px;" placeholder="Buscar club...">
        <div id="search-results" style="max-height: 300px; overflow-y: auto;" class="scroll-area"></div>
    </div>

    <!-- Navegación -->
    <div style="display: flex; gap: 8px; padding: 0 24px 20px 24px;">
        <button onclick="updateGiallo(-1)" id="btn-prev" class="btn-nav">AYER</button>
        <button onclick="updateGiallo(0)" id="btn-today" class="btn-nav active">HOY</button>
        <button onclick="updateGiallo(1)" id="btn-next" class="btn-nav">MAÑANA</button>
    </div>

    <!-- Feed Principal -->
    <div id="giallo-feed" class="scroll-area"></div>

    <!-- Modal Detalles -->
    <div id="giallo-modal" class="modal-overlay scroll-area">
        <div style="display: flex; justify-content: flex-start; margin-bottom: 20px;">
            <button onclick="closeModal()" style="background:#111; border:none; color:white; padding:10px 20px; border-radius:12px; font-size:10px; font-weight:900;">← VOLVER</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<script>
    (function() {
        const KEY = "3af7c318c595188d2f4fbd7b9071c1c4";
        const URL = "https://v3.football.api-sports.io";
        let userFavs = JSON.parse(localStorage.getItem('giallo_user_favs')) || [];
        let searchTimeout;

        const LEAGUE_PRIORITY = { 2: 100, 11: 95, 128: 90, 13: 85, 130: 80, 140: 75, 39: 75 };

        async function callApi(path) {
            try {
                const r = await fetch(`${URL}/${path}`, {
                    headers: { "x-rapidapi-key": KEY, "x-rapidapi-host": "v3.football.api-sports.io" }
                });
                return await r.json();
            } catch (e) { return null; }
        }

        window.toggleSearchUI = () => {
            const box = document.getElementById('search-box');
            box.style.display = box.style.display === 'none' ? 'block' : 'none';
        };

        window.closeModal = () => { document.getElementById('giallo-modal').style.display = 'none'; };

        window.showMatch = async (id) => {
            const body = document.getElementById('modal-body');
            document.getElementById('giallo-modal').style.display = 'block';
            body.innerHTML = '<p style="text-align:center; padding:100px; font-size:10px; font-weight:900; color:#3b82f6;">CARGANDO...</p>';

            const data = await callApi(`fixtures?id=${id}&timezone=America/Argentina/Buenos_Aires`);
            const m = data.response[0];

            const events = m.events || [];
            const homeEvents = events.filter(e => e.team.id === m.teams.home.id);
            const awayEvents = events.filter(e => e.team.id === m.teams.away.id);

            const stats = m.statistics || [];
            const getStat = (label) => {
                if(!stats.length) return {h:0, a:0, ph:0, pa:0};
                const h = stats[0].statistics.find(s => s.type === label)?.value || 0;
                const a = stats[1].statistics.find(s => s.type === label)?.value || 0;
                const total = (parseFloat(h) || 0) + (parseFloat(a) || 0);
                return { h, a, ph: total ? (parseFloat(h)/total)*100 : 50, pa: total ? (parseFloat(a)/total)*100 : 50 };
            };

            const pos = getStat("Ball Possession");

            body.innerHTML = `
                <div style="text-align:center; margin-bottom:30px;">
                    <p style="font-size:10px; color:#555; font-weight:900; margin-bottom:20px;">${m.league.name.toUpperCase()}</p>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="width:35%;">
                            <img src="${m.teams.home.logo}" style="width:50px;">
                            <p style="font-size:11px; font-weight:900; margin-top:10px;">${m.teams.home.name}</p>
                        </div>
                        <div style="width:30%;">
                            <p style="font-size:36px; font-weight:900;">${m.goals.home ?? 0}:${m.goals.away ?? 0}</p>
                            <p style="font-size:9px; color:#ef4444; font-weight:900;">${m.fixture.status.long.toUpperCase()}</p>
                        </div>
                        <div style="width:35%;">
                            <img src="${m.teams.away.logo}" style="width:50px;">
                            <p style="font-size:11px; font-weight:900; margin-top:10px;">${m.teams.away.name}</p>
                        </div>
                    </div>
                </div>

                <div style="background:#0a0a0a; border-radius:20px; padding:20px; border:1px solid #111; margin-bottom:20px;">
                    <p style="font-size:9px; font-weight:900; color:#444; margin-bottom:12px; text-align:center;">ESTADÍSTICAS</p>
                    <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:900; margin-bottom:5px;">
                        <span>${pos.h || '0%'}</span><span>POSESIÓN</span><span>${pos.a || '0%'}</span>
                    </div>
                    <div class="stat-bar-bg"><div style="background:#3b82f6; width:${pos.ph}%"></div><div style="background:#222; width:${pos.pa}%"></div></div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        ${homeEvents.map(e => `<div style="display:flex; justify-content:flex-end; gap:8px; font-size:10px; margin-bottom:10px; text-align:right;"><span>${e.player.name}<br><small style="color:#444">${e.detail}</small></span><b style="color:#3b82f6;">${e.time.elapsed}'</b></div>`).join('')}
                    </div>
                    <div>
                        ${awayEvents.map(e => `<div style="display:flex; gap:8px; font-size:10px; margin-bottom:10px;"><b style="color:#3b82f6;">${e.time.elapsed}'</b><span>${e.player.name}<br><small style="color:#444">${e.detail}</small></span></div>`).join('')}
                    </div>
                </div>
            `;
        };

        window.updateGiallo = async (offset) => {
            const feed = document.getElementById('giallo-feed');
            document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
            if(offset === -1) document.getElementById('btn-prev').classList.add('active');
            if(offset === 0) document.getElementById('btn-today').classList.add('active');
            if(offset === 1) document.getElementById('btn-next').classList.add('active');

            feed.innerHTML = '<p style="text-align:center; padding:100px; font-size:10px; font-weight:900; color:#3b82f6;">ACTUALIZANDO...</p>';

            const argDate = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Argentina/Buenos_Aires"}));
            argDate.setDate(argDate.getDate() + offset);
            const dateStr = argDate.toISOString().split('T')[0];

            const data = await callApi(`fixtures?date=${dateStr}&timezone=America/Argentina/Buenos_Aires`);

            if(!data?.response?.length) {
                feed.innerHTML = '<p style="text-align:center; padding:100px; color:#333; font-size:10px; font-weight:900;">SIN PARTIDOS HOY</p>';
                return;
            }

            // --- LÓGICA DE AGRUPACIÓN POR LIGA ---
            const grouped = {};
            data.response.forEach(m => {
                const lId = m.league.id;
                if(!grouped[lId]) grouped[lId] = { info: m.league, matches: [] };
                grouped[lId].matches.push(m);
            });

            // Ordenar ligas por prioridad
            const sortedLeagues = Object.values(grouped).sort((a, b) => (LEAGUE_PRIORITY[b.info.id] || 0) - (LEAGUE_PRIORITY[a.info.id] || 0));

            feed.innerHTML = '';
            sortedLeagues.forEach(group => {
                // Header de Liga
                const lHead = document.createElement('div');
                lHead.className = 'league-header';
                lHead.innerHTML = `<img src="${group.info.logo}" style="width:16px; height:16px; object-fit:contain;"><span style="font-size:9px; font-weight:900; letter-spacing:1px; color:#555;">${group.info.name.toUpperCase()}</span>`;
                feed.appendChild(lHead);

                // Partidos de esa liga
                group.matches.forEach(m => {
                    const status = m.fixture.status.short;
                    const isLive = ["1H", "2H", "HT"].includes(status);
                    const isFT = ["FT", "AET", "PEN"].includes(status);
                    const isNS = status === "NS";

                    let labelClass = "status-next";
                    let labelText = status;
                    if(isLive) { labelClass = "status-live"; labelText = `${m.fixture.status.elapsed}'`; }
                    if(isFT) { labelClass = "status-final"; labelText = "FIN"; }
                    if(isNS) { labelText = new Date(m.fixture.date).toLocaleTimeString("es-AR", { hour: '2-digit', minute: '2-digit', timeZone: "America/Argentina/Buenos_Aires" }); }

                    const card = document.createElement('div');
                    card.className = 'match-card';
                    card.onclick = () => showMatch(m.fixture.id);
                    card.innerHTML = `
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="width:35%; display:flex; align-items:center; gap:10px;">
                                <img src="${m.teams.home.logo}" style="width:20px; height:20px; object-fit:contain;">
                                <span style="font-size:11px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.teams.home.name}</span>
                            </div>
                            <div style="width:20%; text-align:center;">
                                <span style="font-size:14px; font-weight:900; color:${isLive?'#ef4444':'#fff'}">${isNS ? '-' : m.goals.home} : ${isNS ? '-' : m.goals.away}</span>
                            </div>
                            <div style="width:35%; display:flex; align-items:center; gap:10px; justify-content:flex-end;">
                                <span style="font-size:11px; font-weight:700; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.teams.away.name}</span>
                                <img src="${m.teams.away.logo}" style="width:20px; height:20px; object-fit:contain;">
                            </div>
                            <div style="width:10%; text-align:right;">
                                <span class="status-label ${labelClass}" style="padding:2px 5px; font-size:7px;">${labelText}</span>
                            </div>
                        </div>
                    `;
                    feed.appendChild(card);
                });
            });
        };

        // Búsqueda y Favoritos
        document.getElementById('team-search-input').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            clearTimeout(searchTimeout);
            if(query.length < 3) return;
            searchTimeout = setTimeout(async () => {
                const data = await callApi(`teams?search=${query}`);
                const res = document.getElementById('search-results');
                res.innerHTML = '';
                data.response.forEach(item => {
                    const t = item.team;
                    const div = document.createElement('div');
                    div.style = "display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #111; align-items:center;";
                    div.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><img src="${t.logo}" style="width:20px;"> <span style="font-size:11px; font-weight:900;">${t.name}</span></div> 
                                     <button onclick="toggleFixTeam(${t.id}, '${t.name}', '${t.logo}')" style="background:#111; color:#3b82f6; border:none; border-radius:8px; padding:5px 10px; font-size:10px;">★</button>`;
                    res.appendChild(div);
                });
            }, 500);
        });

        window.toggleFixTeam = (id, name, logo) => {
            const index = userFavs.findIndex(f => f.id === id);
            if(index > -1) userFavs.splice(index, 1);
            else { if(userFavs.length >= 6) userFavs.shift(); userFavs.push({id, name, logo}); }
            localStorage.setItem('giallo_user_favs', JSON.stringify(userFavs));
            renderFavBar();
            updateGiallo(0);
        };

        function renderFavBar() {
            const container = document.getElementById('fav-container');
            container.innerHTML = '';
            userFavs.forEach(team => {
                const img = document.createElement('img');
                img.src = team.logo;
                img.style = "width:36px; height:36px; border-radius:50%; border:1px solid #222; padding:5px; cursor:pointer; background:#0a0a0a; flex-shrink:0;";
                img.onclick = () => updateGiallo(0); // Podría filtrar, pero por ahora refresca
                container.appendChild(img);
            });
        }

        function start() {
            renderFavBar();
            updateGiallo(0);
            setInterval(() => {
                document.getElementById('tn-clock').innerText = new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Argentina/Buenos_Aires' }) + ' • BUENOS AIRES';
            }, 1000);
        }
        start();
    })();
</script>

